<!DOCTYPE html>
<html lang="en">
<head>
    {% if args.title.as_ref().is_none() %}
    <title>MicroBin</title>
    {%- else %}
    <title>{{ args.title.as_ref().unwrap() }}</title>
    {%- endif %}

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Modern, fast, and secure pastebin service">
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.ico">

    <!-- 现代化增强样式 -->
    {% if !args.pure_html %}
        {% if args.custom_css.as_ref().is_none() || args.custom_css.as_ref().unwrap() == "" %}
            <link rel="stylesheet" href="/static/modern-enhanced.css">
        {%- else %}
            <link rel="stylesheet" href="{{ args.custom_css.as_ref().unwrap() }}">
        {%- endif %}
    {%- endif %}

    <!-- 预加载关键资源 -->
    <link rel="preload" href="/static/modern-enhanced.css" as="style">
    <link rel="preload" href="/static/aes.js" as="script">

    <!-- JavaScript for enhanced functionality -->
    <script type="text/javascript" src="/static/aes.js"></script>
    
    <!-- 现代化交互脚本 -->
    <script>
        // 性能监控
        const perfStart = performance.now();
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            const perfEnd = performance.now();
            console.log(`Page loaded in ${(perfEnd - perfStart).toFixed(2)}ms`);
            
            // 添加页面加载动画
            document.body.classList.add('animate-fade-in');
            
            // 初始化所有交互功能
            initFormEnhancements();
            initFileUpload();
            initCopyFunctionality();
            initAnimations();
            initAccessibility();
        });

        // 表单增强功能
        function initFormEnhancements() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                // 表单提交加载状态
                form.addEventListener('submit', function(e) {
                    const submitBtn = form.querySelector('input[type="submit"], button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.classList.add('loading');
                        submitBtn.disabled = true;
                        
                        // 添加提交动画
                        submitBtn.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            submitBtn.style.transform = '';
                        }, 150);
                    }
                });

                // 实时表单验证
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('blur', validateField);
                    input.addEventListener('input', debounce(validateField, 300));
                });
            });

            // 自动调整textarea高度
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                // 初始调整
                adjustTextareaHeight(textarea);
                
                textarea.addEventListener('input', function() {
                    adjustTextareaHeight(this);
                });
            });
        }

        // 文件上传增强
        function initFileUpload() {
            const fileLabel = document.querySelector('.file-upload-area');
            const fileInput = document.querySelector('.file-input');
            
            if (!fileLabel || !fileInput) return;

            // 拖拽事件处理
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileLabel.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // 拖拽视觉反馈
            ['dragenter', 'dragover'].forEach(eventName => {
                fileLabel.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileLabel.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                fileLabel.classList.add('drag-over');
            }

            function unhighlight(e) {
                fileLabel.classList.remove('drag-over');
            }

            // 文件拖拽处理
            fileLabel.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files;
                    updateFileLabel(files[0]);
                    
                    // 添加成功动画
                    fileLabel.classList.add('animate-bounce');
                    setTimeout(() => {
                        fileLabel.classList.remove('animate-bounce');
                    }, 1000);
                }
            }

            // 文件选择处理
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    updateFileLabel(this.files[0]);
                }
            });

            function updateFileLabel(file) {
                const icon = getFileIcon(file.type);
                const size = formatFileSize(file.size);
                
                fileLabel.innerHTML = `
                    <div class="file-upload-content">
                        ${icon}
                        <div class="file-upload-text">${file.name}</div>
                        <div class="file-upload-subtext">${size}</div>
                    </div>
                `;
            }
        }

        // 复制功能增强
        function initCopyFunctionality() {
            // 动态获取基础URL的函数
            window.getBaseUrl = function() {
                const publicPath = `{{ args.public_path_as_str() }}`;
                const shortPath = `{{ args.short_path_as_str() }}`;
                
                if (shortPath !== "") {
                    return shortPath;
                } else if (publicPath !== "") {
                    return publicPath;
                } else {
                    return window.location.origin;
                }
            };

            // 增强的复制函数
            window.copyToClipboard = function(text, button) {
                if (!navigator.clipboard) {
                    // 降级方案
                    fallbackCopyTextToClipboard(text, button);
                    return;
                }

                navigator.clipboard.writeText(text).then(function() {
                    showCopySuccess(button);
                }).catch(function(err) {
                    console.error('Failed to copy: ', err);
                    fallbackCopyTextToClipboard(text, button);
                });
            };

            function showCopySuccess(button) {
                const originalText = button.textContent;
                const originalClass = button.className;
                
                button.textContent = '✓ Copied!';
                button.classList.add('btn-success');
                button.classList.add('animate-pulse');
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.className = originalClass;
                }, 2000);
            }

            function fallbackCopyTextToClipboard(text, button) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showCopySuccess(button);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                
                document.body.removeChild(textArea);
            }
        }

        // 动画初始化
        function initAnimations() {
            // 滚动动画观察器
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fade-in-up');
                    }
                });
            }, observerOptions);

            // 观察所有卡片
            document.querySelectorAll('.card').forEach(card => {
                observer.observe(card);
            });
        }

        // 无障碍功能
        function initAccessibility() {
            // 键盘导航增强
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    document.body.classList.add('keyboard-navigation');
                }
            });

            document.addEventListener('mousedown', function() {
                document.body.classList.remove('keyboard-navigation');
            });

            // 为所有交互元素添加焦点环
            const interactiveElements = document.querySelectorAll('button, a, input, select, textarea');
            interactiveElements.forEach(element => {
                element.classList.add('focus-ring');
            });
        }

        // 工具函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(textarea.scrollHeight, 120) + 'px';
        }

        function validateField(e) {
            const field = e.target;
            // 这里可以添加具体的验证逻辑
            // 目前只是示例框架
        }

        function getFileIcon(mimeType) {
            const iconMap = {
                'image/': `<svg class="file-upload-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>`,
                'video/': `<svg class="file-upload-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path></svg>`,
                'audio/': `<svg class="file-upload-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 11-1.414-1.414A7.971 7.971 0 0017 12c0-2.21-.895-4.21-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 12a5.984 5.984 0 01-.757 2.828 1 1 0 11-1.415-1.656A3.989 3.989 0 0013 12a3.989 3.989 0 00-.172-1.172 1 1 0 010-1.657z" clip-rule="evenodd"></path></svg>`,
                'default': `<svg class="file-upload-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>`
            };

            for (const [type, icon] of Object.entries(iconMap)) {
                if (mimeType.startsWith(type)) {
                    return icon;
                }
            }
            return iconMap.default;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</head>

<body class="page-container">
    {% if !args.hide_header %}
    <nav class="navbar container">
        <div class="navbar-brand">
            {% if !args.hide_logo %}
            <a href="/" class="navbar-brand">
                <img src="/static/logo.png" alt="MicroBin Logo">
                {% if args.title.as_ref().is_some() %}
                <span>{{ args.title.as_ref().unwrap() }}</span>
                {% else %}
                <span>MicroBin</span>
                {%- endif %}
            </a>
            {%- endif %}
        </div>
        
        <div class="navbar-nav">
            <a href="/" class="nav-link">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                New
            </a>
            
            {% if !args.no_listing %}
            <a href="/list" class="nav-link">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg>
                List
            </a>
            {%- endif %}
            
            <a href="/guide" class="nav-link">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                </svg>
                Guide
            </a>

            <button id="theme-toggle" class="nav-link" onclick="toggleTheme()">
                <svg id="theme-icon-light" width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="display: none;">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                </svg>
                <svg id="theme-icon-dark" width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>
                <span id="theme-text">Dark</span>
            </button>
        </div>
    </nav>
    {%- endif %}
    
    <main class="page-main container">
